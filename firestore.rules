rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Public leaderboard: anyone can read; only authed users can create
    match /scores/{docId} {
      allow read: if true;
      allow create: if request.auth != null
        && request.resource.data.keys().hasOnly(['username','score','uid','createdAt'])
        && request.resource.data.username is string
        && request.resource.data.score is int
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.createdAt == request.time;
      allow update, delete: if false;
    }

    // User profile and favourites (only owner access)
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null && request.auth.uid == uid
        && request.resource.data.keys().hasOnly(['displayName','updatedAt'])
        && request.resource.data.displayName is string
        && request.resource.data.updatedAt == request.time;
      allow delete: if false;

      match /favourites/{favId} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow create: if request.auth != null && request.auth.uid == uid
          && request.resource.data.keys().hasOnly(['lat','lng','panoId','label','createdAt','order'])
          && request.resource.data.lat is number
          && request.resource.data.lng is number
          && (request.resource.data.panoId == null || request.resource.data.panoId is string)
          && request.resource.data.label is string
          && request.resource.data.order is number
          && request.resource.data.createdAt == request.time;
        allow update: if request.auth != null && request.auth.uid == uid
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['label','order'])
          && request.resource.data.label is string
          && request.resource.data.order is number;
        allow delete: if request.auth != null && request.auth.uid == uid;
      }
    }
  }
}
